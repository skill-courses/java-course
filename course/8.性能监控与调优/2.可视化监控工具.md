# 可视化监控工具

![monitor-tools-ui](https://i.loli.net/2021/05/15/KEPYjNwqCTpdWQ6.jpg)

通过前面一节的学习，我们知道了命令行监控工具的基本使用，这些命令行工具是最基本的JVM监控工具，凭借着其简单易用的特性，在服务端的实时监控中应用广泛。但是，这些命令行工具对内存溢出、内存泄露以及线程死锁等较深层次的监控就相当有限，同时由于命令行提供的数据可视化能力较弱，阅读和排查问题较难。所以，今天我们就来学习一些可视化的监控工具，这些工具在我们进行应用程序性能调优的时候比较方便。

## Jconsole

Jconsole是JDK自带的允许用户监控并管理Java应用程序的图形工具。JConsole将连接到运行在同一个工作站或远程工作站上的应用程序。前提是这些应用程序必须配置为允许访问。

首先，我们在命令行中输入`jconsole`命令，将进入如下窗口：

![jconsole-connect](https://i.loli.net/2021/05/15/R9zb5AqBSUfltHa.jpg)

选择你需要连接的应用程序线程，点击连接，进入概览(overview)页面(选择不安全连接)：

![jconsole-overview](https://i.loli.net/2021/05/15/Asb6qxRcvmOueQ7.jpg)

在这个页面，你可以查看堆内存(Heap memory), 线程(Threads), 类(Classes), CUP利用率等。

当然，关于详细的堆内存，你可以进入内存页面(Memory)进一步查看,这个tab包含了各种内存的使用情况，包括Eden区，Old区等等。

![jconsole-memory](https://i.loli.net/2021/05/15/iu2UsyxBkW7A6O4.jpg)

当然，关于线程的死锁检测和类的加载情况，你可以通过Threads和Classes类来详细查看。

对于VM Summary Tab，这个页面使用文字的方式，对JVM当前的状态和参数进行了一些列罗列，使用起来十分方便：

![jconsole-vm-summary](https://i.loli.net/2021/05/15/LUeQZXBAiahbKDR.jpg)

总体而言，此图形化界面满足了基本的监控需要，同时是JDK自带的监控工具，不需要额外下载和安装，但是其提供的功能实在是十分有限，对进一步的性能诊断还是提供不了太多有价值的信息。

> 注： 由于 JConsole 会消耗大量系统资源，因此 Oracle 建议仅在用于创建原型的开发环境中使用它。还建议使用远程监控将 JConsole 应用程序与所监控的平台隔离。

## Java Mission Control(JMC): 可持续在线的监控工具

由于Jconsole在使用的过程中消耗大量的系统资源，所以不能作为长时间持续性监控的工具，于是JDK提供了一款能够持续在线监控的工具`JMC`。

`Java Mission Control`使您能够监视和管理Java应用程序，而不会引入通常与这些类型的工具相关联的性能开销。它使用为Java虚拟机（JVM）的常规自适应动态优化收集的数据。除了最小化性能开销之外，这种方法还消除了观察器效应的问题，当监视工具改变系统的执行特性时会发生这种问题。

当Java版本大于13之后，JMC需要自己下载，请点击这里[下载JMC](https://www.oracle.com/java/technologies/javase/products-jmc8-downloads.html),下载完成之后，解压，点击`Java Mission Control`图标即可启动：

![jmc-home](https://i.loli.net/2021/05/15/E3T4wfd8bSIoshx.jpg)

在首页中，我们可以看到进程的使用情况，CPU的利用率，Memory的使用情况，这些东西和JConsole提供的功能基本类似，这里就不必过多阐述。比较特别的是，JMC提供了触发器(Trigger)的功能，主要用于当某个条件满足是，出发某个行为，比如CPU利用率超过80%，发送告警邮件等。

![jmc-trigger](https://i.loli.net/2021/05/15/F7WMp3NUxkfVez4.jpg)

当然，这套工具最牛逼的地方在于其提供了一个强大的飞行记录仪JFR(Flight Recoder), JFR是一套内建在HotSpot虚拟机里面的监控和基于事件的信息收集框架，与其他的监控工具相比，Oracle特别强调它可持续在线的特性。JFR在生产环境中对吞吐量的影响一般不会高于1%，而且JFR监控过程的开始，停止都是完全可动态的，既不需要重启应用。同时，JFR的监控对应用也是完全透明的，既不需要对应用程序的源码做任何修改，或者基于特定的代理来运行。

JFR的基本工作原理是开启一系列时间的录制动作，当某个时间发生时，这个事件的所有上下文数据将会以循环日志的形式被保存至内存或者指定的某个文件当中，循环日志相当于数据流被保留在一个环形缓存中，所以只有最近发生的事件才是可用的。JMC从虚拟机内存或者文件中读取并展示这些事件数据，并通过这些数据进行性能分析。

双击JFR将会出现飞行记录仪的启动窗口：

![jmc-jfr-start](https://i.loli.net/2021/05/15/sJxGXdnk2wqPmBQ.jpg)

我们可以对此设置特定的记录时间和相关参数，点击完成开始记录，记录完成结果如下：

![jmc-jfr](https://i.loli.net/2021/05/15/i7OVAkLTHgaQuNs.jpg)

JFR里面主要包含以下几类信息：

* 一般信息：关于虚拟机、操作系统和记录的一般信息。
* 内存：关于内存管理和垃圾收集的信息。
* 代码：关于方法，异常错误，编译和类加载信息。
* 线程：关于应用程序中线程和锁的信息。
* I/O：关于文件和套接字输入、输出的信息。
* 系统：关于政治运行Java的虚拟机的系统、进程和环境变量的信息。
* 事件：关于记录汇总的事件类型的信息，可以根据线程或者堆栈跟踪，按照日志或者图形的格式查看。

## VisualVM：多合-故障处理工具

VisualVM(All in One Java Troubleshooting Tool)是功能最强大的运行监视和故障处理工具，曾经在很长一段时间内是Oracle官方主力发展的虚拟机故障处理工具，除了常规的运行监视、故障处理外，还将提供其他方面的能力，譬如性能分析(Profiling)。

VisualVM相比其他工具来说，有一个很大的优点：不需要被监视的程序基于特殊Agent去运行，因此它的通用性很强，对应用程序实际性能的影响也较小，使得它可以直接应用在生产环境中。

### 分析程序性能

在Profiler页签中，VisualVM提供了程序运行期间方法级别的处理器执行时间分析以及内存分析。要开始性能分析，先选择“CPU”和“内存”按钮中的一个，然后切换到应用程序中的对程序进行操作，VisualVM会记录这段时间中应用程序执行过的所有方法。如果是进行处理器执行时间分析，将会统计每个方法执行的次数，耗时；如果是内存分析，则会统计每个方法关联的对象数以及这些对象所占用的空间。

等要分析的操作执行结束后，点击“暂停”按钮结束监控过程，如图所示：

![VisualVM-profiler](https://i.loli.net/2021/05/17/Wdrh9buBDKnCEgY.jpg)

### 生成堆转储快照

在VisualVM中生成堆转储快照文件有两种方式，可以执行下列任一操作：
* 在“应用程序”窗口中右键单击应用程序节点，然后选择“堆Dump”。
* 在“应用程序”窗口中双击应用程序节点以打开应用程序标签，然后在“监视”标签中点击“堆Dump”。

生成堆转储快照文件之后，应用程序页签会在该堆的应用程序下增加一个以[heap-dump]开头的子节点，并且在主页签中打开该转储快照。如果需要把堆转储快照保存或发送出去，就应该在heapdump节点上右键选择“另存为”菜单，否则当VisualVM关闭时，生成的堆转储快照文件会被当做临时文件自动清理掉。要打开一个由已经存在的堆转储快照文件，通过文件菜单的“装入”功能，选择硬盘上的文件即可。

![VisualVM-dump](https://i.loli.net/2021/05/17/pI8Xwm6azPYEHGd.jpg)

### 插件安装

VisualVM基于NetBeans平台开发，所以它从一开始就具备了通过插件扩展功能的能力，有了插件扩展的加持，VisualVM可以实现如下功能：

* 显示虚拟机进程以及进程的配置、环境信息(类似于jps，jinfo)
* 监视应用程序的处理器，垃圾收集，堆，方法区以及线程的信息(Jstat，jstack)
* dump以及分析堆转储快照(jmap, jhat)
* 方法级别的程序运行性能分析，找出被调用最多、运行时间最长的方法
* 离线程序快照，收集程序的运行时配置，线程dump，内存dump等信息建立一个快照，可以将快照发送开发者处进行bug反馈。
* 其他插件带来的无限可能性

在有网络的环境中，点击“工具”->”插件菜单“，弹出插件页签，点击自己需要安装的插件进行安装即可。

![visualvm-plugin](https://i.loli.net/2021/05/17/qBjmV4PerF5TCEI.jpg)

### BTrace动态日志跟踪

上面我们在插件安装页面安装了BTrace插件，此插件相当的神奇：BTrace插件的作用是在不中断程序运行的前提下，通过HotSpot虚拟机的Instrument功能动态加入原本并不存在的调试代码。这项功能对实际生产环境意义重大：如果程序出现问题时，排查错误的一些必要信息(譬如方法参数，返回值等)，在开发时并没有打印到日志之中以至于不得不停掉服务时，都可以通过调试增量来加入日志代码以解决问题。

详细的使用请参考下面的连接：

* [BTrace 简要介绍](https://www.jianshu.com/p/93e94b724476)
* [VisualVM-BTrace](https://www.cnblogs.com/xiashiwendao/p/6511587.html)
* [Using VisualVM, BTrace & Good Old Web Search](https://dzone.com/articles/debugging-netbeans-with-visualvm-and-btrace)






