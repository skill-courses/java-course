# 类的连接与初始化

![class-connect](https://i.loli.net/2021/04/26/ZMc8tApVgs9mr6X.jpg)

通过前面的学习，我们知道类的生命周期包括`加载`、`连接`、`初始化`、`使用`和`卸载`等过程，加载的过程我们已经学习了，今天我们就来了解一下类的连接和初始化吧！

## 类的连接

类的连接主要分为三个阶段：`验证`、`准备`、`解析`, 我们来简单了解一下：

### 验证

由于我们的字节码来源多样化，并不一定来源于Class文件，所以我们需要通过一些措施来保证字节码的二进制流是正确的安全的，因此我们需要通过验证来避免虚拟机受到攻击。主要验证如下内容：

1. **类文件结构检查：** 按照JVM规范规定的类文件结构进行检查。
2. **元数据验证：** 对字节码描述的信息进行语义分析，保证其符合Java语言规范要求。
3. **字节码验证：** 通过对数据流和字节流进行分析，确保程序语义是合法和符合逻辑的，主要对方法体进行的校验。
4. **符号引用验证：** 对类自身以外的信息，也就是常量池中的各种符号引用，进行匹配校验。

### 准备

准备阶段是为类变量（static）设置内存并分配初始值的阶段，这里强调以下两点：

* 只是类变量，不包含实例变量，实例变量会在对象实例化的时候分配到堆上，但类变量（变量内存）都会在方法区（元数据）中分配内存。
* 只是分配初始值，初始值见下表，有一种情况例外，就是如果字段属性表有ConstantValue(stati final修饰的变量)属性，准备阶段就会为变量赋值而不是初始值。

|数据类型|初始值|
|:-----:|:----:|
| int | 0 |
| long | 0L |
| short | (short)0 |
| char | '\u0000' |
| byte | (byte)0 |
| boolean | false |
| float | 0.0f |
| double | 0.0d |
| reference | null |

### 解析

解析阶段是虚拟机将常量池中的符号引用替换为直接引用的过程，符号引用在Class文件中以CONSTANT_Class_info、CONSTANT_Fieldref_info、CONSTANT_Methodref_info等类型的常量出现。

* 符号引用：以一组符号表示引用的目标，可以是任何形式的字面量，只要可以定位到目标即可。
* 直接引用：直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。 

如果有了直接引用，那么引用的目标必定已经在内存中存在。

此过程主要针对的是类、接口、字段、类方法、接口方法、方法类型、方法句柄、调用限定符等。
