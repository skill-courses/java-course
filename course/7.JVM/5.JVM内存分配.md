# JVM 内存分配

![java-mermory](https://tva1.sinaimg.cn/large/008i3skNly1gpyp4e2hrlj30he0avgml.jpg)

对Java程序员来说，在虚拟机自动内存管理机制的帮助下，不再需要为每一个new操作去写配对的delete/free代码，不容易出现内存泄漏和内存溢出的问题，看起来由虚拟机管理内存一切都很美好。不过，也正是因为Java程序员把控制内存的权利交给了Java虚拟机，一旦出现内存泄漏和溢出的问题，如果不了解虚拟机是怎么样使用内存的，那么排查错误，修正问题将是一个非常艰难的任务。今天我们就来简单了解一下JVM的内存分配的知识。

## 运行时数据区

![run-time-data-area](https://tva1.sinaimg.cn/large/008i3skNly1gpzt5t3563j30e809mwfd.jpg)

一个类被JVM加载进来之后，就放到了内存中，这个内存被统称为运行时数据区。这个内存被划分为若干个不同的数据区域，这些区域有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而一直存在，有些区域则是依赖用户线程的启动和结束而建立和销毁。主要包括`程序计数器`、`虚拟机栈`、`本地方法栈`、`方法区`和`堆`等五个区域，接下来我们将分别介绍这五个区域的作用。

### 程序计数器(Program Counter Register)

程序计数器是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。

Java虚拟机的多线程是通过线程轮流切换、分配处理器执行时间的方法来实现的，在任何一个确定的时刻，一个处理器都只会执行一条线程中的指令。因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储，我们称这类内存区域为”线程私有“的内存。

所以，每个线程拥有一个程序计数器，是线程私有的，用来存储指向下一条指令的地址，所以是一块较小的内存空间，是唯一一个在JVM规范中没有规定OutOfMemoryError的内存区域；在创建线程的时候，创建相应的程序计数器。

如果一个线程执行的是一个Java方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果在执行的是本地(Native)方法,这个计数器的值则为空(Undefined)。

### Java虚拟机栈

在Java虚拟机中，每个方法被执行的时候，Java虚拟都会同步创建一个栈帧用于存储局部变量表，操作数栈、动态连接、方法出口等信息。每一个方法被调用直至执行完毕的过程，就对应着一个栈帧在虚拟机中从入栈到出栈的过程。

所以，栈就是有一系列帧(Frame)组成的，是每个线程私有的。

局部变量表存放了编译期间可知的各种数据基本类型和引用类型，这些数据类型在局部变量表中的存储空间以局部变量槽(Slot)来表示，其中64位的long和double类型的数据会占用两个变量槽，其余的数据类型只占用一个。局部变量表所需的内存空间在编译期间完成分配，当进入一个方法时，这个方法需要在栈帧中分配多大的局部变量空间是完全确定的，在方法运行期间不会改变局部变量表的大小。

所以，栈的优缺点相当明显：
* 优点：存取速度比堆快，仅次于寄存器。
* 缺点：存在栈中的数据大小、生存期实在编译器决定的，缺乏灵活性。

### 本地方法栈

本地方法栈与虚拟机所发挥的作用是非常相似的，其区别只是虚拟机栈为虚拟机执行Java方法服务，而本地方法栈则是为虚拟机使用到的本地方法(Native)服务。

### Java 堆
